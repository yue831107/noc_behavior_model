# Memory Copy 操作

本文件說明 Host Memory 到 Local Memory 的複製機制。

---

## 1. 架構概述

### 1.1 簡化架構

```
┌─────────────┐
│ Host Memory │  (Source)
└──────┬──────┘
       │
       ▼ AXI Write (Host 是 AXI Master)
┌──────────────┐
│   Slave NI   │  ← 單一入口 (V1 限制)，接收 Host AXI Master 請求
└──────┬───────┘
       │
       ▼ Req Flit
┌──────────────┐
│   Selector   │  ← 選擇最佳 Edge Router
└──────┬───────┘
       │
   ┌───┴───┐
   ▼       ▼
┌─────┐ ┌─────┐
│Node0│ │Node1│ ... (16 nodes)
│ LM  │ │ LM  │     Local Memory (經 Master NI)
└─────┘ └─────┘
```

### 1.2 完整 V1 Memory Copy 架構

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              HOST SIDE                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         Host Memory                                     │ │
│  │   ┌──────────────────────────────────────────────────────────────┐     │ │
│  │   │  Source Data: [block0][block1][block2]...[blockN]             │     │ │
│  │   │  (copy_size bytes，分割成 block_size 區塊)                     │     │ │
│  │   └──────────────────────────────────────────────────────────────┘     │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                         │
│                                    ▼  AXI Write Request (AW + W)             │
└────────────────────────────────────┼─────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼─────────────────────────────────────────┐
│  V1 SINGLE ENTRY POINT             │                                         │
│  ┌─────────────────────────────────▼───────────────────────────────────────┐ │
│  │                    Slave NI (Host 的 AXI Slave Interface)               │ │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────────────┐  │ │
│  │  │  Address         │  │  Flit Packer     │  │  Outstanding Tracker  │  │ │
│  │  │  Translation     │  │  (AXI→Flit)      │  │  (max_outstanding)    │  │ │
│  │  │  NodeID→(x,y)    │  │                  │  │                       │  │ │
│  │  └──────────────────┘  └──────────────────┘  └───────────────────────┘  │ │
│  └─────────────────────────────────┬───────────────────────────────────────┘ │
│                                    │                                         │
│  ┌─────────────────────────────────▼───────────────────────────────────────┐ │
│  │                      Routing Selector                                   │ │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Path Selection: min(hop_weight × hops - credit_weight × credits)  │ │ │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │ │ │
│  │  │  │ Port 3  │  │ Port 2  │  │ Port 1  │  │ Port 0  │  ← Credit     │ │ │
│  │  │  │ credit  │  │ credit  │  │ credit  │  │ credit  │    Counters   │ │ │
│  │  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘               │ │ │
│  │  └───────┼────────────┼────────────┼────────────┼─────────────────────┘ │ │
│  └──────────┼────────────┼────────────┼────────────┼───────────────────────┘ │
└─────────────┼────────────┼────────────┼────────────┼─────────────────────────┘
              │            │            │            │
              ▼            ▼            ▼            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  NOC MESH (5×4)                                                              │
│                                                                              │
│     Edge Routers        Compute Nodes (with Master NI + Local Memory)        │
│     (Column 0)          (Columns 1-4)                                        │
│                                                                              │
│    ┌────┐              ┌────┬────┐  ┌────┬────┐  ┌────┬────┐  ┌────┬────┐   │
│  3 │E.R3│◄────────────►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│ │
│    │(0,3)│              │(1,3)│[12] │  │(2,3)│[13] │  │(3,3)│[14] │  │(4,3)│[15] │ │
│    └──┬─┘              └──┬─┴────┘  └──┬─┴────┘  └──┬─┴────┘  └──┬─┴────┘   │
│       │                   │            │            │            │          │
│    ┌──┴─┐              ┌──┴─┬────┐  ┌──┴─┬────┐  ┌──┴─┬────┐  ┌──┴─┬────┐   │
│  2 │E.R2│◄────────────►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│ │
│    │(0,2)│              │(1,2)│[8]  │  │(2,2)│[9]  │  │(3,2)│[10] │  │(4,2)│[11] │ │
│    └──┬─┘              └──┬─┴────┘  └──┬─┴────┘  └──┬─┴────┘  └──┬─┴────┘   │
│       │                   │            │            │            │          │
│    ┌──┴─┐              ┌──┴─┬────┐  ┌──┴─┬────┐  ┌──┴─┬────┐  ┌──┴─┬────┐   │
│  1 │E.R1│◄────────────►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│ │
│    │(0,1)│              │(1,1)│[4]  │  │(2,1)│[5]  │  │(3,1)│[6]  │  │(4,1)│[7]  │ │
│    └──┬─┘              └──┬─┴────┘  └──┬─┴────┘  └──┬─┴────┘  └──┬─┴────┘   │
│       │                   │            │            │            │          │
│    ┌──┴─┐              ┌──┴─┬────┐  ┌──┴─┬────┐  ┌──┴─┬────┐  ┌──┴─┬────┐   │
│  0 │E.R0│◄────────────►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│◄─►│ R  │NI+LM│ │
│    │(0,0)│              │(1,0)│[0]  │  │(2,0)│[1]  │  │(3,0)│[2]  │  │(4,0)│[3]  │ │
│    └────┘              └────┴────┘  └────┴────┘  └────┴────┘  └────┴────┘   │
│                                                                              │
│  圖例: E.R = Edge Router, R = Router, NI+LM = Master NI + Local Memory        │
│        [n] = Node ID                                                         │
└─────────────────────────────────────────────────────────────────────────────┘

資料流向 (Write Request):
    Host Memory → Slave NI → Selector → Edge Router → NoC Mesh → Master NI → Local Memory
    (Host側)      (AXI Slave)                        (Req Router)  (AXI Master)  (AXI Slave)

Response 流向 (B Response):
    Local Memory → Master NI → NoC Mesh → Edge Router → Selector → Slave NI → Host
    (AXI Slave)    (AXI Master) (Rsp Router)                       (AXI Slave)  (AXI Master)
```

### 1.3 交錯傳輸時序

(`parallel_nodes=4`):
```
Cycle │ Node0    Node1    Node2    Node3    Node4   ...
──────┼──────────────────────────────────────────────────
  0   │ blk0 ──►
  1   │          blk0 ──►
  2   │                   blk0 ──►
  3   │                            blk0 ──►
  4   │ blk1 ──►                            (等待)
  5   │          blk1 ──►
  6   │                   blk1 ──►
  7   │                            blk1 ──►
 ...  │                                     (Node0-3 完成後，
      │                                      Node4-7 開始)
```

---

## 2. V1 架構限制

> **重要**: V1 架構**僅有單一入口點**

| 元件 | 數量 | 限制 |
|------|------|------|
| AXI Master | 1 | 單一 CPU/DMA |
| Slave NI | 1 | 單一 Protocol Conversion 點 (接收 Host AXI Master 請求) |
| Routing Selector | 1 | 單一入口選擇器 |

**影響**:
- 所有流量必須經過單一 Slave NI
- 無真正硬體並行 (需 V2 Multi-NI 架構)
- `max_outstanding` 決定 Pipeline 深度

---

## 3. 交錯 vs 順序傳輸

由於 V1 架構限制，"平行" 傳輸實為**交錯** (Interleaved) 傳輸:

**順序** (`parallel_nodes=1`):
```
Node0.blk0 → Node0.blk1 → Node0.blk2 → ... → Node0 完成
Node1.blk0 → Node1.blk1 → Node1.blk2 → ... → Node1 完成
...
```

**交錯** (`parallel_nodes=4`):
```
Node0.blk0 → Node1.blk0 → Node2.blk0 → Node3.blk0 →
Node0.blk1 → Node1.blk1 → Node2.blk1 → Node3.blk1 →
...
```

---

## 4. 交錯的效能優勢

| 模式 | Cycles | Throughput | 原因 |
|------|--------|------------|------|
| 順序 | 168 | 9.58 B/cycle | 單一路徑，等待 Response |
| 交錯 (4) | 87 | 18.60 B/cycle | 路徑分散，減少等待 |

**效能提升來源**:
1. **路徑分散**: 不同目的地使用不同 Edge Router
2. **減少 Head-of-line Blocking**: 不卡在單一目的地
3. **Pipeline 效果**: 多筆未完成交易同時在網路中

---

## 5. Flit 大小限制

| 參數 | 值 |
|------|-----|
| Flit Payload 大小 | 32 bytes |
| Packet Header | 12 bytes |
| **單 Flit 最大資料量** | **20 bytes** |

當 `block_size > 20 bytes` 時，需多個 Flits 組成封包。使用 Wormhole Routing 時，HEAD Flit 不等待完整封包即可轉發。

**建議**: 使用 `block_size ≤ 20` 以維持 Single-Flit 傳輸。

---

## 6. 真正硬體並行 (V2)

真正硬體並行需 V2 架構:
- 多個 AXI Masters (多 DMA/CPU)
- 多個 Slave NIs (多入口點)
- Smart Crossbar (並行路由)

---

## 相關文件

- [系統概述](01_overview.md)
- [操作模式](07_operation_modes.md)
- [V2 Smart Crossbar](A1_v2_smart_crossbar.md)
