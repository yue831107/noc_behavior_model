# 硬體參數設計指南

本文件說明 NoC 硬體可調參數及其效能影響。

---

## 1. 參數總覽

```
┌─────────────────────────────────────────────────────────────────────┐
│                        參數層級架構                                  │
│                                                                     │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐            │
│   │   Mesh      │    │   Router    │    │     NI      │            │
│   │  拓撲參數    │    │  硬體參數    │    │  介面參數    │            │
│   └─────────────┘    └─────────────┘    └─────────────┘            │
│         │                  │                  │                     │
│    cols × rows        buffer_depth       max_outstanding            │
│    edge_column        pipeline_mode      flit_payload_size          │
│                       flit_width         axi_data_width             │
└─────────────────────────────────────────────────────────────────────┘
```

| 類別 | 參數 | 預設值 | 主要影響 |
|------|------|--------|----------|
| Mesh | `cols × rows` | 5 × 4 | 網路規模 |
| Router | `buffer_depth` | 4 | 壅塞容忍度 |
| Router | `pipeline_mode` | fast | 延遲精度 |
| NI | `max_outstanding` | 16 | 並行度 |
| NI | `flit_payload_size` | 32 B | 封包效率 |

---

## 2. Mesh 拓撲參數

### 2.1 網格結構

```
       Column 0    Column 1-4 (Compute Nodes)
       (Edge)
         │
    ┌────┴────┬─────────┬─────────┬─────────┐
    │  (0,3)  │  (1,3)  │  (2,3)  │  (3,3)  │  (4,3)  │  Row 3
    ├─────────┼─────────┼─────────┼─────────┼─────────┤
    │  (0,2)  │  (1,2)  │  (2,2)  │  (3,2)  │  (4,2)  │  Row 2
    ├─────────┼─────────┼─────────┼─────────┼─────────┤
    │  (0,1)  │  (1,1)  │  (2,1)  │  (3,1)  │  (4,1)  │  Row 1
    ├─────────┼─────────┼─────────┼─────────┼─────────┤
    │  (0,0)  │  (1,0)  │  (2,0)  │  (3,0)  │  (4,0)  │  Row 0
    └─────────┴─────────┴─────────┴─────────┴─────────┘
         ↑
    Edge Routers              Compute Nodes
    (僅 Router)            (Router + NI + Memory)
```

### 2.2 關鍵公式

```
N_nodes = (cols - 1) × rows        # Compute Node 數量
T_max   = rows × W_flit            # 理論最大吞吐量 (Selector 瓶頸)
D_max   = (cols - 1) + (rows - 1)  # 最大 Manhattan 距離
```

### 2.3 範例計算

| 配置 | cols | rows | N_nodes | T_max | D_max |
|------|------|------|---------|-------|-------|
| 預設 | 5 | 4 | 16 | 32 B/c | 7 hops |
| 小型 | 3 | 2 | 4 | 16 B/c | 3 hops |
| 大型 | 9 | 8 | 64 | 64 B/c | 15 hops |

---

## 3. Router 參數

### 3.1 Buffer Depth

```
Buffer Depth 與壅塞的關係：

buffer_depth = 2          buffer_depth = 8
┌───┬───┐                 ┌───┬───┬───┬───┬───┬───┬───┬───┐
│ F │ F │ ← 容易滿        │ F │ F │   │   │   │   │   │   │ ← 餘裕大
└───┴───┘                 └───┴───┴───┴───┴───┴───┴───┴───┘

壅塞風險: 高              壅塞風險: 低
面積成本: 低              面積成本: 高
```

| buffer_depth | 壅塞容忍度 | 面積成本 | 適用場景 |
|--------------|-----------|---------|---------|
| 2-4 | 低 | 低 | 低負載、面積敏感 |
| 4-8 | 中 | 中 | 一般應用 (推薦) |
| 8-16 | 高 | 高 | 高負載、突發流量 |
| 16-32 | 極高 | 極高 | 極端壅塞場景 |

### 3.2 Pipeline Mode

```
Pipeline 階段:
  RC = Route Computation (路由計算)
  VA = Virtual Channel Allocation (VC 分配)
  SA = Switch Allocation (交換分配)
  ST = Switch Traversal (交換穿越)
```

| 模式 | RC | VA | SA | ST | 總延遲 | 用途 |
|------|:--:|:--:|:--:|:--:|:------:|------|
| **fast** | 1 | - | - | - | **1 cycle/hop** | 快速模擬 |
| standard | 1 | - | 1 | - | 2 cycles/hop | 平衡 |
| hardware | 1 | 1 | 1 | 1 | 4 cycles/hop | 精確時序 |

**延遲計算公式**：

```
L_min = hops × P_depth + L_overhead

範例 (5 hops):
  fast:     5 × 1 + 2 = 7 cycles
  standard: 5 × 2 + 2 = 12 cycles
  hardware: 5 × 4 + 2 = 22 cycles
```

### 3.3 Flit Width

```
Flit Width 與頻寬:

flit_width = 64 bits (8 bytes)  ← 預設
  │
  ├── 每 cycle 傳輸 8 bytes
  └── T_max = 4 × 8 = 32 B/cycle (5×4 mesh)

flit_width = 128 bits (16 bytes)
  │
  ├── 每 cycle 傳輸 16 bytes
  └── T_max = 4 × 16 = 64 B/cycle (面積 ×2)
```

---

## 4. NI 參數

### 4.1 Max Outstanding

```
Outstanding 交易數與吞吐量:

max_outstanding = 4              max_outstanding = 32
┌───┬───┬───┬───┐                ┌───┬───┬...───┬───┐
│T1 │T2 │T3 │T4 │ ← 並行 4 筆    │T1 │T2 │ ... │T32│ ← 並行 32 筆
└───┴───┴───┴───┘                └───┴───┴...───┴───┘

吞吐量: 受限                     吞吐量: 高
記憶體: 低                       記憶體: 高
```

| max_outstanding | 吞吐量潛力 | 記憶體成本 | 適用場景 |
|-----------------|-----------|-----------|---------|
| 4-8 | 低 | 低 | 簡單控制流 |
| 16 | 中 | 中 | 一般應用 (預設) |
| 32-64 | 高 | 高 | 高吞吐需求 |

### 4.2 Flit Payload Size

```
封包效率計算:

transfer_size = 256 bytes
flit_payload  = 32 bytes

N_flits = ceil(256 / 32) = 8 flits

┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐
│ HEAD │ BODY │ BODY │ BODY │ BODY │ BODY │ BODY │ TAIL │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘
   32B    32B    32B    32B    32B    32B    32B    32B
```

| flit_payload_size | 封包數 (256B) | Header 開銷 | 適用場景 |
|-------------------|--------------|-------------|---------|
| 16 B | 16 flits | 高 | 小封包優化 |
| 32 B | 8 flits | 中 | 一般應用 (預設) |
| 64 B | 4 flits | 低 | 大封包優化 |
| 128 B | 2 flits | 極低 | 批量傳輸 |

---

## 5. 參數影響矩陣

```
參數調整方向        效能指標影響
     ↓                  ↓

              ┌──────────┬──────────┬──────────┐
              │Throughput│ Latency  │ 壅塞容忍  │
┌─────────────┼──────────┼──────────┼──────────┤
│↑ buffer_    │    ○     │    ✗     │    ✓     │
│   depth     │ 無明顯   │ 略增     │ 大幅改善  │
├─────────────┼──────────┼──────────┼──────────┤
│↑ max_       │    ✓     │    ○     │    ○     │
│ outstanding │ 顯著提升  │ 無明顯   │ 無明顯   │
├─────────────┼──────────┼──────────┼──────────┤
│↑ mesh_size  │    ✓     │    ✗     │    ○     │
│             │ 容量增加  │ 距離增加  │ 無明顯   │
├─────────────┼──────────┼──────────┼──────────┤
│↓ pipeline   │    ○     │    ✓     │    ○     │
│   depth     │ 無明顯   │ 顯著降低  │ 無明顯   │
└─────────────┴──────────┴──────────┴──────────┘

圖例: ✓ 正向改善  ✗ 負向影響  ○ 無明顯影響
```

---

## 6. 設計範例

### 6.1 高吞吐量配置

**目標**: 達到 30 B/cycle

```
約束分析:
  T_max = rows × 8 B/c
  需求: T ≥ 30 B/c
  → rows ≥ 30/8 = 3.75 → rows = 4

瓶頸: Routing Selector (4 ports × 8 B = 32 B/c)
```

**推薦配置**:

```python
MeshConfig(cols=5, rows=4)           # T_max = 32 B/c
RouterConfig(buffer_depth=8)         # 壅塞容忍
NIConfig(max_outstanding=32)         # 高並行
```

**預期結果**:

```
T_max = 32 B/c
目標 30 B/c → 94% utilization → ✓ 可達成
```

---

### 6.2 低延遲配置

**目標**: 最小化延遲

```
延遲公式:
  L_min = hops × P_depth + 2

最小化策略:
  1. 使用 fast pipeline (P_depth = 1)
  2. 減少 hop 數 (目標節點選擇)
```

**推薦配置**:

```python
RouterConfig(
    buffer_depth=4,                  # 最小即可
    pipeline=PipelineConfig.fast()   # 1 cycle/hop
)
```

**預期結果**:

```
範例: (0,0) → (2,1), 3 hops
L_min = 3 × 1 + 2 = 5 cycles
```

---

### 6.3 高並行配置

**目標**: 支援 64 個並行交易

```
並行度分析:
  max_outstanding = 64
  需配合足夠的 buffer 避免阻塞
```

**推薦配置**:

```python
NIConfig(
    max_outstanding=64,              # 高並行
    req_buffer_depth=32,             # 請求緩衝
    resp_buffer_depth=32             # 回應緩衝
)

RouterConfig(
    buffer_depth=16                  # 避免網路壅塞
)
```

---

## 7. 調參流程

```
┌─────────────────────────────────────────────────────────────┐
│                      參數調優流程                            │
│                                                             │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ 1. 定義   │ ──►│ 2. 初始   │ ──►│ 3. 執行   │             │
│   │ 效能目標  │    │ 參數配置  │    │ 模擬     │             │
│   └──────────┘    └──────────┘    └──────────┘             │
│                                         │                   │
│                                         ▼                   │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ 6. 達成   │ ◄──│ 5. 調整   │ ◄──│ 4. 驗證   │             │
│   │ 目標     │    │ 參數     │    │ 結果     │             │
│   └──────────┘    └──────────┘    └──────────┘             │
│        │               ▲                                    │
│        │               │                                    │
│        └───── 未達成 ──┘                                    │
└─────────────────────────────────────────────────────────────┘
```

**步驟說明**:

| 步驟 | 動作 | 工具 |
|------|------|------|
| 1 | 定義目標 (如: T ≥ 25 B/c, L < 10 cycles) | - |
| 2 | 選擇初始參數 (參考本文件範例) | - |
| 3 | 執行模擬 | `make sim` |
| 4 | 驗證結果是否合理 | `make test_performance` |
| 5 | 根據結果調整參數 | - |
| 6 | 達成目標或取得最佳折衷 | - |

---

## 相關文件

- [效能驗證框架](14_performance_validation.md) - 驗證公式
- [效能指標](12_metrics.md) - Stats 類別
- [模擬參數](11_simulation.md) - 模擬配置
